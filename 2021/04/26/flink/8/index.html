<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="理解Flink中的Task和SubTask"><meta name="keywords" content="Flink"><meta name="author" content="Tunan"><meta name="copyright" content="Tunan"><title>理解Flink中的Task和SubTask | TUNANのBlog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概念"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DATAFLOWS数据流介绍"><span class="toc-number">2.</span> <span class="toc-text">DATAFLOWS数据流介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#串行数据流"><span class="toc-number">2.1.</span> <span class="toc-text">串行数据流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#并行数据流"><span class="toc-number">2.2.</span> <span class="toc-text">并行数据流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何划分-TASK-的依据"><span class="toc-number">2.3.</span> <span class="toc-text">如何划分 TASK 的依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何计算-TASK-和-SUBTASK-个数"><span class="toc-number">2.4.</span> <span class="toc-text">如何计算 TASK 和 SUBTASK 个数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DEMO进行TASK划分"><span class="toc-number">2.5.</span> <span class="toc-text">DEMO进行TASK划分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#TASK总数：4"><span class="toc-number">2.5.0.1.</span> <span class="toc-text">TASK总数：4</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SUBTASK总数：11"><span class="toc-number">2.5.0.2.</span> <span class="toc-text">SUBTASK总数：11</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OPERATOR-CHAINS介绍"><span class="toc-number">3.</span> <span class="toc-text">OPERATOR CHAINS介绍</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/xiaoqi.jpg"></div><div class="author-info__name text-center">Tunan</div><div class="author-info__description text-center">BigData Developer</div><div class="follow-button"><a href="#">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">271</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">39</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">35</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://hadoop.apache.org/docs/r2.10.0/hadoop-project-dist/hadoop-common/SingleCluster.html" target="_blank" rel="noopener">HADOOP</a><a class="author-info-links__name text-center" href="https://cwiki.apache.org/confluence/display/Hive/" target="_blank" rel="noopener">HIVE</a><a class="author-info-links__name text-center" href="http://archive.cloudera.com/cdh5/cdh/5/" target="_blank" rel="noopener">CDH</a><a class="author-info-links__name text-center" href="http://flume.apache.org/" target="_blank" rel="noopener">FLUME</a><a class="author-info-links__name text-center" href="https://azkaban.github.io/" target="_blank" rel="noopener">AZKABAN</a><a class="author-info-links__name text-center" href="https://www.maxinhong.com/" target="_blank" rel="noopener">叶梨子</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/qingyunzong" target="_blank" rel="noopener">老铁</a><a class="author-info-links__name text-center" href="https://blog.csdn.net/jim8973/" target="_blank" rel="noopener">飞哥</a><a class="author-info-links__name text-center" href="https://vinxikk.github.io/" target="_blank" rel="noopener">vinx</a><a class="author-info-links__name text-center" href="http://dongxicheng.org/" target="_blank" rel="noopener">懂西成(Hadoop技术内幕作者)</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/xing901022/" target="_blank" rel="noopener">xingoo</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/itboys/tag/" target="_blank" rel="noopener">大葱拌豆腐</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/shishanyuan" target="_blank" rel="noopener">郭景瞻(图解Spark作者)</a><a class="author-info-links__name text-center" href="https://segmentfault.com/u/wishdaren_5c243b920a3eb" target="_blank" rel="noopener">Wish大人</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/huxi2b/" target="_blank" rel="noopener">huxi_2b(kafka)</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/soroush-golpoor-1497416-unsplash.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">TUNANのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">理解Flink中的Task和SubTask</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Flink/">Flink</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1k</span><span class="post-meta__separator">|</span><span>Reading time: 3 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><code>Task(任务)</code>:Task 是一个阶段多个功能相同 subTask 的集合，类似于 Spark 中的 TaskSet (Stage)。</p>
<p><code>subTask(子任务)</code>：subTask 是 Flink 中任务最小执行单元，是一个 Java 类的实例，这个 Java 类中有属性和方法，完成具体的计算逻辑。</p>
<p><code>Operator Chains(算子链)</code>：没有 shuffle 的多个算子合并在一个 subTask 中，就形成了 Operator Chains，类似于 Spark 中的 Pipeline。</p>
<p><code>Slot(插槽)</code>：Flink 中计算资源进行隔离的单元，一个 Slot 中可以运行多个 subTask，但是这些 subTask 必须是来自同一个 application 的不同阶段的 subTask。</p>
<p><code>State(状态)</code>：Flink 在运行过程中计算的中间结果</p>
<h2 id="DATAFLOWS数据流介绍"><a href="#DATAFLOWS数据流介绍" class="headerlink" title="DATAFLOWS数据流介绍"></a>DATAFLOWS数据流介绍</h2><p>Dataflows数据流介绍，参考自 <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/concepts/programming-model.html" target="_blank" rel="noopener">Flink 官方文档</a>。</p>
<p>Flink 程序的基本构建是 <code>流(Stream)</code>和<code>转换(Transform)</code>。</p>
<p>从概念上讲，<code>流是对当前数据流向的记录（流也可能是永无止境的）</code> ，而<code>转换是将一个或多个流作为输入，根据需要求转换成我们要的格式的流的过程。</code></p>
<p>当程序执行时，Flink程序会将数据流进行<code>映射、转换</code>运算成我们要的格式的流。每个数据流都以一个或多个源(Source)开始，并以一个或多个接收器(Sink)结束，数据流类似于任意<code>有向无环图(DAG)</code>。</p>
<h3 id="串行数据流"><a href="#串行数据流" class="headerlink" title="串行数据流"></a>串行数据流</h3><p><img src="https://yerias.github.io/flink/0e8e2ecf7b8beaa9fb19e7749165eb69.png" alt=""></p>
<p>多个 Operator 之间，通过 Stream 流进行连接，Source、Transformation、Sink之间就形成了一个有向非闭环的 Dataflow Graph(数据流图)。</p>
<h3 id="并行数据流"><a href="#并行数据流" class="headerlink" title="并行数据流"></a>并行数据流</h3><p>Flink 中的程序本质上是并行的。在执行期间，每一个算子(Transformation)都有<code>一个或多个算子subTask（Operator SubTask）</code>，每个算子的 subTask 之间都是彼此独立，并在不同的线程中执行，并且可能在不同的机器或容器上执行。</p>
<p><code>Operator subTask 的数量指的就是算子的并行度</code>。同一程序的不同算子也可能具有不同的并行度（因为可以通过 setParallelism() 方法来修改并行度）</p>
<p><img src="https://yerias.github.io/flink/3f0a91b0c337b6a0ec764ead87a1ab68.png" alt=""></p>
<h3 id="如何划分-TASK-的依据"><a href="#如何划分-TASK-的依据" class="headerlink" title="如何划分 TASK 的依据"></a>如何划分 TASK 的依据</h3><ol>
<li>并行度发生变化时;</li>
<li>keyBy() /window()/apply() 等发生 Rebalance 重新分配;</li>
<li>调用 startNewChain() 方法，开启一个新的算子链；</li>
<li>调用 diableChaining()方法，即：告诉当前算子操作不使用 算子链 操作。</li>
</ol>
<p>针对内存密集型、CPU密集型，使用 <code>startNewChins()、disableChaining()方法</code>，可以将当前算子单独放到一个 Task 中，使其独享当前Task的所有资源，以此来提升计算效率。</p>
<h3 id="如何计算-TASK-和-SUBTASK-个数"><a href="#如何计算-TASK-和-SUBTASK-个数" class="headerlink" title="如何计算 TASK 和 SUBTASK 个数"></a>如何计算 TASK 和 SUBTASK 个数</h3><p><img src="https://yerias.github.io/flink/1e76580c7b55aa3d470a9bf250a21956.png" alt=""></p>
<p>上图并行数据流，一共有 3个 Task，5个 subTask。</p>
<p>流可以按照<code>一对一</code>模式或<code>重新分配</code>模式在两个 Operator 算子之间传输数据：</p>
<ol>
<li>一对一的流：（<code>例如上图中的 Source 和 map() 算子之间的流</code>）它们都保留各自元素的分区和排序。即：map() 算子的 subtask[1] 将会与产生相同元素顺序的Source() 算子的 subtask[1] 关联，进行数据传输。</li>
<li>重新分配的流：（例如上图的 <code>map()和 keyBy()/window()之间</code>以及 <code>keyBy ()/window()和Sink之间</code>）重新分配流会改变流的分区。每个<code>算子subTask</code>都将数据发送到不同的目标subTask，具体 subTask 取决于所选算子使用的转换方法。例如： keyBy() 通过 Hash 散列重新分区、broadcast()广播、或者 rebalance() (随机重新分区)。</li>
</ol>
<h3 id="DEMO进行TASK划分"><a href="#DEMO进行TASK划分" class="headerlink" title="DEMO进行TASK划分"></a>DEMO进行TASK划分</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TaskDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">		<span class="keyword">val</span> stream = env.socketTextStream(<span class="string">"aliyun"</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">		stream</span><br><span class="line">		  .flatMap(_.split(<span class="string">","</span>))</span><br><span class="line">		  .map((_, <span class="number">1</span>))</span><br><span class="line">		  .keyBy(<span class="number">0</span>)</span><br><span class="line">		  .sum(<span class="number">1</span>)</span><br><span class="line">		  .print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		env.execute(<span class="keyword">this</span>.getClass.getSimpleName)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="TASK总数：4"><a href="#TASK总数：4" class="headerlink" title="TASK总数：4"></a>TASK总数：4</h5><p><img src="https://yerias.github.io/flink/b7b3ff8fbf6e4acea1d0f9c254c26e9d.png" alt=""></p>
<h5 id="SUBTASK总数：11"><a href="#SUBTASK总数：11" class="headerlink" title="SUBTASK总数：11"></a>SUBTASK总数：11</h5><p><img src="https://yerias.github.io/flink/20776d562ce25419708318bfd368c59d.png" alt=""></p>
<h2 id="OPERATOR-CHAINS介绍"><a href="#OPERATOR-CHAINS介绍" class="headerlink" title="OPERATOR CHAINS介绍"></a>OPERATOR CHAINS介绍</h2><p>Operator Chains介绍，参考自：<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/concepts/runtime.html" target="_blank" rel="noopener">Flink官方文档</a></p>
<p>Flink 将多个 subTask 合并成一个 Task(任务)，这个过程叫做 <code>Operator Chains</code>，每个任务由一个线程执行。使用 Operator Chains（算子链） 可以将多个分开的 subTask 拼接成一个任务。<code>Operator Chains 是一个有用的优化，它减少了线程到线程的切换和缓冲的开销，并在降低延迟的同时提高了总体吞吐量。</code></p>
<p>下图中的示例，数据流由五个子任务执行，因此由五个并行线程执行。</p>
<p><img src="https://yerias.github.io/flink/bf988654918eab230a0abd3ada582824.png" alt=""></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Tunan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yerias.github.io/2021/04/26/flink/8/">http://yerias.github.io/2021/04/26/flink/8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Flink/">Flink</a></div><div class="social-share" data-disabled="facebook,twitter,douban,linkedin,diandian"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/04/27/flink/9/"><i class="fa fa-chevron-left">  </i><span>理解Flink中的背压</span></a></div><div class="next-post pull-right"><a href="/2021/04/25/error/11/"><span>Yarn在Shuffle阶段内存不足问题(error in shuffle in fetcher)</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/soroush-golpoor-1497416-unsplash.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2021 By Tunan</div><div class="framework-info"><span>Driven - </span><a href="#"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="#"><span>Melody</span></a></div><div class="footer_custom_text">大家好，我是图南，很高兴认识你们！</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>