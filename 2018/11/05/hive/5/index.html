<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="HS2&amp;Hive的复杂数据结构&amp;行列互转&amp;常用函数&amp;静动态分区表&amp;桶表"><meta name="keywords" content="Hive"><meta name="author" content="Tunan"><meta name="copyright" content="Tunan"><title>HS2&amp;Hive的复杂数据结构&amp;行列互转&amp;常用函数&amp;静动态分区表&amp;桶表 | TUNANのBlog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#目标"><span class="toc-number">1.</span> <span class="toc-text">目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SH2"><span class="toc-number">2.</span> <span class="toc-text">SH2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复杂数据结构"><span class="toc-number">3.</span> <span class="toc-text">复杂数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#array"><span class="toc-number">3.1.</span> <span class="toc-text">array</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#准备数据"><span class="toc-number">3.1.1.</span> <span class="toc-text">准备数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对array数组的”取”"><span class="toc-number">3.1.2.</span> <span class="toc-text">对array数组的”取”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#map"><span class="toc-number">3.2.</span> <span class="toc-text">map</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#准备数据-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">准备数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对map键值对的”取”"><span class="toc-number">3.2.2.</span> <span class="toc-text">对map键值对的”取”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#structs"><span class="toc-number">3.3.</span> <span class="toc-text">structs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#准备数据-2"><span class="toc-number">3.3.1.</span> <span class="toc-text">准备数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对structs结构体的”取”"><span class="toc-number">3.3.2.</span> <span class="toc-text">对structs结构体的”取”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#行列互转"><span class="toc-number">4.</span> <span class="toc-text">行列互转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备数据-3"><span class="toc-number">4.1.</span> <span class="toc-text">准备数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#需求"><span class="toc-number">4.2.</span> <span class="toc-text">需求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#行转列"><span class="toc-number">4.2.1.</span> <span class="toc-text">行转列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#聚合查询"><span class="toc-number">4.2.2.</span> <span class="toc-text">聚合查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#列转行"><span class="toc-number">4.2.3.</span> <span class="toc-text">列转行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用函数"><span class="toc-number">5.</span> <span class="toc-text">常用函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#时间函数"><span class="toc-number">5.1.</span> <span class="toc-text">时间函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数值函数"><span class="toc-number">5.2.</span> <span class="toc-text">数值函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字符串函数"><span class="toc-number">5.3.</span> <span class="toc-text">字符串函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Json处理函数"><span class="toc-number">5.4.</span> <span class="toc-text">Json处理函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Null值处理函数"><span class="toc-number">5.5.</span> <span class="toc-text">Null值处理函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他函数"><span class="toc-number">5.6.</span> <span class="toc-text">其他函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#静动态分区表"><span class="toc-number">6.</span> <span class="toc-text">静动态分区表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作"><span class="toc-number">6.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#静态分区加载数据"><span class="toc-number">6.2.</span> <span class="toc-text">静态分区加载数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态分区加载数据"><span class="toc-number">6.3.</span> <span class="toc-text">动态分区加载数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分区注意"><span class="toc-number">6.4.</span> <span class="toc-text">分区注意</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#桶表"><span class="toc-number">7.</span> <span class="toc-text">桶表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#分桶的概念"><span class="toc-number">7.1.</span> <span class="toc-text">分桶的概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分桶的好处"><span class="toc-number">7.2.</span> <span class="toc-text">分桶的好处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分桶实践"><span class="toc-number">7.3.</span> <span class="toc-text">分桶实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#有序的分桶表"><span class="toc-number">7.4.</span> <span class="toc-text">有序的分桶表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分桶抽样查询"><span class="toc-number">7.5.</span> <span class="toc-text">分桶抽样查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL示例"><span class="toc-number">7.5.1.</span> <span class="toc-text">SQL示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#区别"><span class="toc-number">7.5.2.</span> <span class="toc-text">区别:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#语法"><span class="toc-number">7.5.3.</span> <span class="toc-text">语法:</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/xiaoqi.jpg"></div><div class="author-info__name text-center">Tunan</div><div class="author-info__description text-center">BigData Developer</div><div class="follow-button"><a href="#">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">120</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">28</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">24</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://hadoop.apache.org/docs/r2.10.0/hadoop-project-dist/hadoop-common/SingleCluster.html" target="_blank" rel="noopener">HADOOP</a><a class="author-info-links__name text-center" href="https://cwiki.apache.org/confluence/display/Hive/" target="_blank" rel="noopener">HIVE</a><a class="author-info-links__name text-center" href="http://archive.cloudera.com/cdh5/cdh/5/" target="_blank" rel="noopener">CDH</a><a class="author-info-links__name text-center" href="http://flume.apache.org/" target="_blank" rel="noopener">FLUME</a><a class="author-info-links__name text-center" href="https://azkaban.github.io/" target="_blank" rel="noopener">AZKABAN</a><a class="author-info-links__name text-center" href="https://www.maxinhong.com/" target="_blank" rel="noopener">叶梨子</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/qingyunzong" target="_blank" rel="noopener">老铁</a><a class="author-info-links__name text-center" href="https://blog.csdn.net/jim8973/" target="_blank" rel="noopener">飞哥</a><a class="author-info-links__name text-center" href="https://vinxikk.github.io/" target="_blank" rel="noopener">vinx</a><a class="author-info-links__name text-center" href="http://dongxicheng.org/" target="_blank" rel="noopener">懂西成</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/xing901022/" target="_blank" rel="noopener">xingoo</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/soroush-golpoor-1497416-unsplash.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">TUNANのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">HS2&amp;Hive的复杂数据结构&amp;行列互转&amp;常用函数&amp;静动态分区表&amp;桶表</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-11-05</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Hive/">Hive</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.1k</span><span class="post-meta__separator">|</span><span>Reading time: 19 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ol>
<li>HS2</li>
<li>复杂数据结构</li>
<li>行列互转</li>
<li>常用函数</li>
<li>静动态分区表</li>
<li>桶表</li>
</ol>
<h2 id="SH2"><a href="#SH2" class="headerlink" title="SH2"></a>SH2</h2><p>HS2是HiveServer2的简称</p>
<ul>
<li><p>HS2: Server端，默认端口10000</p>
<p>修改端口的方式是通过设置hive.server2.thrift.port的值</p>
</li>
<li><p>beeline: Client端</p>
<p>连接方式: <code>./beeline -u jdbc:hive2://hadoop001:10000/matestore -n hadoop</code></p>
</li>
</ul>
<h2 id="复杂数据结构"><a href="#复杂数据结构" class="headerlink" title="复杂数据结构"></a>复杂数据结构</h2><p>复杂数据类型有三种，分别是: array、map、structs</p>
<h3 id="array"><a href="#array" class="headerlink" title="array"></a>array</h3><p><code>array</code>的建表格式:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> hive_array(<span class="keyword">name</span> <span class="keyword">string</span>, work_locations <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span>;</span><br></pre></td></tr></table></figure>

<p>注意: <code>COLLECTION ITEMS TERMINATED BY &#39;,&#39;</code>是指定array数组中的元素分隔符</p>
<h4 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h4><ol>
<li><p>第一步准备数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pk      beijing,shanghai,tianjin,hangzhou</span><br><span class="line">jepson  changchu,chengdu,wuhan,beijing</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步建表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> array_(</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">	address <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span> </span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">","</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步装载数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">"/home/hadoop/data/hive_array.txt"</span> <span class="keyword">into</span> <span class="keyword">table</span> array_;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步查询数据是否加载成功</p>
<p><code>select * from array_;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">name  |address                                    |</span><br><span class="line"><span class="comment">------|-------------------------------------------|</span></span><br><span class="line">pk    |["beijing","shanghai","tianjin","hangzhou"]|</span><br><span class="line">jepson|["changchu","chengdu","wuhan","beijing"]   |</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="对array数组的”取”"><a href="#对array数组的”取”" class="headerlink" title="对array数组的”取”"></a>对array数组的”取”</h4><ol>
<li><p>根据数组的下标取出指定元素，下标从0开始</p>
<p><code>select name,address[1] as address from array_;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">name  |address |</span><br><span class="line"><span class="comment">------|--------|</span></span><br><span class="line">pk    |shanghai|</span><br><span class="line">jepson|chengdu |</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取数组中元素的个数</p>
<p><code>select name,size(address) as size from array_;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">name  |size|</span><br><span class="line"><span class="comment">------|----|</span></span><br><span class="line">pk    |   4|</span><br><span class="line">jepson|   4|</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取数组中包含某元素的记录</p>
<p><code>select name,address from array_ where  array_contains(address,&quot;shanghai&quot;);</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">name|address                                    |</span><br><span class="line"><span class="comment">----|-------------------------------------------|</span></span><br><span class="line">pk  |["beijing","shanghai","tianjin","hangzhou"]|</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p><code>map</code>的建表格式:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> hive_map(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>, <span class="keyword">name</span> <span class="keyword">string</span>, members <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;, age <span class="built_in">int</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'#'</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>

<p>注意: <code>COLLECTION ITEMS TERMINATED BY &#39;#&#39;</code>是指定map键值对中的元素分隔符，<code>MAP KEYS TERMINATED BY &#39;:&#39;</code>是指定key和value的分隔符</p>
<h4 id="准备数据-1"><a href="#准备数据-1" class="headerlink" title="准备数据"></a>准备数据</h4><ol>
<li><p>第一步准备数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1,zhangsan,father:xiaoming#mother:xiaohuang#brother:xiaoxu,28</span><br><span class="line">2,lisi,father:mayun#mother:huangyi#brother:guanyu,22</span><br><span class="line">3,wangwu,father:wangjianlin#mother:ruhua#sister:jingtian,29</span><br><span class="line">4,mayun,father:mayongzhen#mother:angelababy,26</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步建表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> map_(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">	family <span class="keyword">map</span>&lt;<span class="keyword">String</span>,<span class="keyword">String</span>&gt;,</span><br><span class="line">	age <span class="built_in">int</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">","</span></span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"#"</span></span><br><span class="line"><span class="keyword">map</span> <span class="keyword">keys</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">":"</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步加载数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/hadoop/data/hive_map.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> map_;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步查询数据是否加载成功</p>
<p><code>select * from map_;</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">id|name    |family                                                       |age|</span><br><span class="line"><span class="comment">--|--------|-------------------------------------------------------------|---|</span></span><br><span class="line"> 1|zhangsan|&#123;"father":"xiaoming","mother":"xiaohuang","brother":"xiaoxu"&#125;| 28|</span><br><span class="line"> 2|lisi    |&#123;"father":"mayun","mother":"huangyi","brother":"guanyu"&#125;     | 22|</span><br><span class="line"> 3|wangwu  |&#123;"father":"wangjianlin","mother":"ruhua","sister":"jingtian"&#125;| 29|</span><br><span class="line"> 4|mayun   |&#123;"father":"mayongzhen","mother":"angelababy"&#125;                | 26|</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="对map键值对的”取”"><a href="#对map键值对的”取”" class="headerlink" title="对map键值对的”取”"></a>对map键值对的”取”</h4><ol>
<li><p>根据key取value</p>
<p><code>select name,family[&#39;father&#39;] as father,age from map_;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">name    |father     |age|</span><br><span class="line"><span class="comment">--------|-----------|---|</span></span><br><span class="line">zhangsan|xiaoming   | 28|</span><br><span class="line">lisi    |mayun      | 22|</span><br><span class="line">wangwu  |wangjianlin| 29|</span><br><span class="line">mayun   |mayongzhen | 26|</span><br></pre></td></tr></table></figure>
</li>
<li><p>取出所有key集合</p>
<p><code>select name,map_keys(family) as map_keys,age from map_;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">name    |map_keys                     |age|</span><br><span class="line"><span class="comment">--------|-----------------------------|---|</span></span><br><span class="line">zhangsan|["father","mother","brother"]| 28|</span><br><span class="line">lisi    |["father","mother","brother"]| 22|</span><br><span class="line">wangwu  |["father","mother","sister"] | 29|</span><br><span class="line">mayun   |["father","mother"]          | 26|</span><br></pre></td></tr></table></figure>
</li>
<li><p>取出所有的value集合</p>
<p><code>select name,map_values(family) as map_values,age from map_;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">name    |map_values                        |age|</span><br><span class="line"><span class="comment">--------|----------------------------------|---|</span></span><br><span class="line">zhangsan|["xiaoming","xiaohuang","xiaoxu"] | 28|</span><br><span class="line">lisi    |["mayun","huangyi","guanyu"]      | 22|</span><br><span class="line">wangwu  |["wangjianlin","ruhua","jingtian"]| 29|</span><br><span class="line">mayun   |["mayongzhen","angelababy"]       | 26|</span><br></pre></td></tr></table></figure>
</li>
<li><p>求key的数量(对key集合求size)</p>
<p><code>select name,size(map_keys(family)) as key_size,age from map_;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">name    |key_size|age|</span><br><span class="line"><span class="comment">--------|--------|---|</span></span><br><span class="line">zhangsan|       3| 28|</span><br><span class="line">lisi    |       3| 22|</span><br><span class="line">wangwu  |       3| 29|</span><br><span class="line">mayun   |       2| 26|</span><br></pre></td></tr></table></figure>
</li>
<li><p>求key是否包含某个元素(对key的集合求contains)</p>
<p><code>select name,family,age from map_ where array_contains((map_keys(family)),&quot;brother&quot;);</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">name    |family                                                       |age|</span><br><span class="line"><span class="comment">--------|-------------------------------------------------------------|---|</span></span><br><span class="line">zhangsan|&#123;"father":"xiaoming","mother":"xiaohuang","brother":"xiaoxu"&#125;| 28|</span><br><span class="line">lisi    |&#123;"father":"mayun","mother":"huangyi","brother":"guanyu"&#125;     | 22|</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="structs"><a href="#structs" class="headerlink" title="structs"></a>structs</h3><p><code>structs</code>的建表格式:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> hive_struct(</span><br><span class="line">ip <span class="keyword">string</span>, info <span class="keyword">struct</span>&lt;<span class="keyword">name</span>:<span class="keyword">string</span>,age:<span class="built_in">int</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'#'</span></span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</span><br></pre></td></tr></table></figure>

<p>注意: <code>COLLECTION ITEMS TERMINATED BY &#39;:&#39;</code>是指定每个元素之间的分隔符</p>
<h4 id="准备数据-2"><a href="#准备数据-2" class="headerlink" title="准备数据"></a>准备数据</h4><ol>
<li><p>第一步准备数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">192.168.1.1#zhangsan:40</span><br><span class="line">192.168.1.2#lisi:50</span><br><span class="line">192.168.1.3#wangwu:60</span><br><span class="line">192.168.1.4#zhaoliu:70</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步建表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> structs_(</span><br><span class="line">	address <span class="keyword">string</span>,</span><br><span class="line">	<span class="string">`user`</span> <span class="keyword">struct</span>&lt;<span class="keyword">name</span>:<span class="keyword">string</span>,age:<span class="built_in">int</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"#"</span></span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">":"</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步加载数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">"/home/hadoop/data/hive_struct.txt"</span> <span class="keyword">into</span> <span class="keyword">table</span> structs_;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步查询数据是否装载成功</p>
<p><code>select * from structs_;</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">address    |user                          |</span><br><span class="line"><span class="comment">-----------|------------------------------|</span></span><br><span class="line">192.168.1.1|[&#123;"name":"zhangsan","age":40&#125;]|</span><br><span class="line">192.168.1.2|[&#123;"name":"lisi","age":50&#125;]    |</span><br><span class="line">192.168.1.3|[&#123;"name":"wangwu","age":60&#125;]  |</span><br><span class="line">192.168.1.4|[&#123;"name":"zhaoliu","age":70&#125;] |</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="对structs结构体的”取”"><a href="#对structs结构体的”取”" class="headerlink" title="对structs结构体的”取”"></a>对structs结构体的”取”</h4><ol>
<li><p>取出结构体中的元素</p>
<p><code>select address,user.name as name from structs_;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">address    |name    |</span><br><span class="line"><span class="comment">-----------|--------|</span></span><br><span class="line">192.168.1.1|zhangsan|</span><br><span class="line">192.168.1.2|lisi    |</span><br><span class="line">192.168.1.3|wangwu  |</span><br><span class="line">192.168.1.4|zhaoliu |</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="行列互转"><a href="#行列互转" class="headerlink" title="行列互转"></a>行列互转</h2><p>这是一个复杂数据类型的综合练习</p>
<h3 id="准备数据-3"><a href="#准备数据-3" class="headerlink" title="准备数据"></a>准备数据</h3><ol>
<li><p>第一步准备数据</p>
<p>数据1: session点击广告记录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">11      ad_101  2014-05-01 06:01:12.334+01</span><br><span class="line">22      ad_102  2014-05-01 07:28:12.342+01</span><br><span class="line">33      ad_103  2014-05-01 07:50:12.33+01</span><br><span class="line">11      ad_104  2014-05-01 09:27:12.33+01</span><br><span class="line">22      ad_103  2014-05-01 09:03:12.324+01</span><br><span class="line">33      ad_102  2014-05-02 19:10:12.343+01</span><br><span class="line">11      ad_101  2014-05-02 09:07:12.344+01</span><br><span class="line">35      ad_105  2014-05-03 11:07:12.339+01</span><br><span class="line">22      ad_104  2014-05-03 12:59:12.743+01</span><br><span class="line">77      ad_103  2014-05-03 18:04:12.355+01</span><br><span class="line">99      ad_102  2014-05-04 00:36:39.713+01</span><br><span class="line">33      ad_101  2014-05-04 19:10:12.343+01</span><br><span class="line">11      ad_101  2014-05-05 09:07:12.344+01</span><br><span class="line">35      ad_102  2014-05-05 11:07:12.339+01</span><br><span class="line">22      ad_103  2014-05-05 12:59:12.743+01</span><br><span class="line">77      ad_104  2014-05-05 18:04:12.355+01</span><br><span class="line">99      ad_105  2014-05-05 20:36:39.713+01</span><br></pre></td></tr></table></figure>

<p>数据2: 广告的详情</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ad_101  http://www.google.com   catalog8|catalog1</span><br><span class="line">ad_102  http://www.sohu.com     catalog6|catalog3</span><br><span class="line">ad_103  http://www.baidu.com    catalog7</span><br><span class="line">ad_104  http://www.qq.com       catalog5|catalog1|catalog4|catalog9</span><br><span class="line">ad_105  http://sina.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步创建表</p>
<p>表1: 动作表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> click_tbl(</span><br><span class="line">	cookie_id <span class="keyword">string</span>,  </span><br><span class="line">	ad_id <span class="built_in">int</span>,</span><br><span class="line">	<span class="built_in">time</span> <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span>;</span><br></pre></td></tr></table></figure>

<p>表2: 广告表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ad_tbl(</span><br><span class="line">	ad_id <span class="keyword">string</span>,</span><br><span class="line">	<span class="keyword">url</span> <span class="keyword">string</span>,</span><br><span class="line">	catalogs <span class="built_in">array</span>&lt;<span class="keyword">String</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span></span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"|"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步加载数据</p>
<p>给动作表加载数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">"/home/hadoop/data/click_log.txt"</span> <span class="keyword">into</span> <span class="keyword">table</span> click_tbl;</span><br></pre></td></tr></table></figure>

<p>给广告表加载数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">"/home/hadoop/data/ad_list.txt"</span> <span class="keyword">into</span> <span class="keyword">table</span> ad_tbl;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步查询数据是否装载成功</p>
<p>动作表查询</p>
<p><code>select * from click_tbl;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">cookie_id|ad_id |time                      |</span><br><span class="line"><span class="comment">---------|------|--------------------------|</span></span><br><span class="line">       11|ad_101|2014-05-01 06:01:12.334+01|</span><br><span class="line">       22|ad_102|2014-05-01 07:28:12.342+01|</span><br><span class="line">       33|ad_103|2014-05-01 07:50:12.33+01 |</span><br><span class="line">       11|ad_104|2014-05-01 09:27:12.33+01 |</span><br><span class="line">       22|ad_103|2014-05-01 09:03:12.324+01|</span><br><span class="line">       33|ad_102|2014-05-02 19:10:12.343+01|</span><br><span class="line">       11|ad_101|2014-05-02 09:07:12.344+01|</span><br><span class="line">       35|ad_105|2014-05-03 11:07:12.339+01|</span><br><span class="line">       22|ad_104|2014-05-03 12:59:12.743+01|</span><br><span class="line">       77|ad_103|2014-05-03 18:04:12.355+01|</span><br><span class="line">       99|ad_102|2014-05-04 00:36:39.713+01|</span><br><span class="line">       33|ad_101|2014-05-04 19:10:12.343+01|</span><br><span class="line">       11|ad_101|2014-05-05 09:07:12.344+01|</span><br><span class="line">       35|ad_102|2014-05-05 11:07:12.339+01|</span><br><span class="line">       22|ad_103|2014-05-05 12:59:12.743+01|</span><br><span class="line">       77|ad_104|2014-05-05 18:04:12.355+01|</span><br><span class="line">       99|ad_105|2014-05-05 20:36:39.713+01|</span><br></pre></td></tr></table></figure>

<p>广告把查询</p>
<p><code>select * from ad_tbl;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">ad_id |url                  |catalogs                               |</span><br><span class="line"><span class="comment">------|---------------------|---------------------------------------|</span></span><br><span class="line">ad_101|http://www.google.com|["catalog8|catalog1"]                  |</span><br><span class="line">ad_102|http://www.sohu.com  |["catalog6|catalog3"]                  |</span><br><span class="line">ad_103|http://www.baidu.com |["catalog7"]                           |</span><br><span class="line">ad_104|http://www.qq.com    |["catalog5|catalog1|catalog4|catalog9"]|</span><br><span class="line">ad_105|http://sina.com      |NULL                                   |</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><h4 id="行转列"><a href="#行转列" class="headerlink" title="行转列"></a>行转列</h4><p>查询每个人访问的广告</p>
<ol>
<li><p>去重(collect_set): </p>
<p><code>select cookie_id,collect_set(ad_id) ad_id from click_tbl group by cookie_id;</code></p>
</li>
</ol>
<ul>
<li><p>结果:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">cookie_id|ad_id                       |</span><br><span class="line"><span class="comment">---------|----------------------------|</span></span><br><span class="line">       11|["ad_101","ad_104"]         |</span><br><span class="line">       22|["ad_102","ad_103","ad_104"]|</span><br><span class="line">       33|["ad_103","ad_102","ad_101"]|</span><br><span class="line">       35|["ad_105","ad_102"]         |</span><br><span class="line">       77|["ad_103","ad_104"]         |</span><br><span class="line">       99|["ad_102","ad_105"]         |</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="2">
<li><p>不去重(collect_list):</p>
<p><code>select cookie_id,collect_list(ad_id) ad_id from click_tbl group by cookie_id;</code></p>
</li>
</ol>
<ul>
<li><p>结果:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">cookie_id|ad_id                                |</span><br><span class="line"><span class="comment">---------|-------------------------------------|</span></span><br><span class="line">       11|["ad_101","ad_104","ad_101","ad_101"]|</span><br><span class="line">       22|["ad_102","ad_103","ad_104","ad_103"]|</span><br><span class="line">       33|["ad_103","ad_102","ad_101"]         |</span><br><span class="line">       35|["ad_105","ad_102"]                  |</span><br><span class="line">       77|["ad_103","ad_104"]                  |</span><br><span class="line">       99|["ad_102","ad_105"]                  |</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h4><ol>
<li><p>查询每个人访问相同广告的次数</p>
<p><code>select cookie_id,ad_id,count(1) amount from click_tbl group by  cookie_id,ad_id;</code></p>
<p>结果:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">cookie_id|ad_id |amount|</span><br><span class="line"><span class="comment">---------|------|------|</span></span><br><span class="line">       11|ad_101|     3|</span><br><span class="line">       11|ad_104|     1|</span><br><span class="line">       22|ad_102|     1|</span><br><span class="line">       22|ad_103|     2|</span><br><span class="line">       22|ad_104|     1|</span><br><span class="line">       33|ad_101|     1|</span><br><span class="line">       33|ad_102|     1|</span><br><span class="line">       33|ad_103|     1|</span><br><span class="line">       35|ad_102|     1|</span><br><span class="line">       35|ad_105|     1|</span><br><span class="line">       77|ad_103|     1|</span><br><span class="line">       77|ad_104|     1|</span><br><span class="line">       99|ad_102|     1|</span><br><span class="line">       99|ad_105|     1|</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询每个人访问的广告详情</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	click_tmp.cookie_id,click_tmp.ad_id,ad_tbl.url,ad_tbl.catalogs </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	ad_tbl</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">	(<span class="keyword">select</span> cookie_id,ad_id,<span class="keyword">count</span>(<span class="number">1</span>) amount <span class="keyword">from</span> click_tbl <span class="keyword">group</span> <span class="keyword">by</span>  cookie_id,ad_id) click_tmp</span><br><span class="line"><span class="keyword">on</span> click_tmp.ad_id=ad_tbl.ad_id;</span><br></pre></td></tr></table></figure>

<p>结果:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">cookie_id|ad_id |url                  |catalogs                                     |</span><br><span class="line"><span class="comment">---------|------|---------------------|---------------------------------------------|</span></span><br><span class="line">       11|ad_101|http://www.google.com|["catalog8","catalog1"]                      |</span><br><span class="line">       11|ad_104|http://www.qq.com    |["catalog5","catalog1","catalog4","catalog9"]|</span><br><span class="line">       22|ad_102|http://www.sohu.com  |["catalog6","catalog3"]                      |</span><br><span class="line">       22|ad_103|http://www.baidu.com |["catalog7"]                                 |</span><br><span class="line">       22|ad_104|http://www.qq.com    |["catalog5","catalog1","catalog4","catalog9"]|</span><br><span class="line">       33|ad_101|http://www.google.com|["catalog8","catalog1"]                      |</span><br><span class="line">       33|ad_102|http://www.sohu.com  |["catalog6","catalog3"]                      |</span><br><span class="line">       33|ad_103|http://www.baidu.com |["catalog7"]                                 |</span><br><span class="line">       35|ad_102|http://www.sohu.com  |["catalog6","catalog3"]                      |</span><br><span class="line">       35|ad_105|http://sina.com      |NULL                                         |</span><br><span class="line">       77|ad_103|http://www.baidu.com |["catalog7"]                                 |</span><br><span class="line">       77|ad_104|http://www.qq.com    |["catalog5","catalog1","catalog4","catalog9"]|</span><br><span class="line">       99|ad_102|http://www.sohu.com  |["catalog6","catalog3"]                      |</span><br><span class="line">       99|ad_105|http://sina.com      |NULL                                         |</span><br></pre></td></tr></table></figure>
</li>
<li><p>把catalogs中的数据元素排序</p>
<p><code>select ad_id,url,sort_array(catalogs) as catalogs from ad_tbl;</code></p>
<p>结果:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">ad_id |url                  |catalogs                                     |</span><br><span class="line"><span class="comment">------|---------------------|---------------------------------------------|</span></span><br><span class="line">ad_101|http://www.google.com|["catalog1","catalog8"]                      |</span><br><span class="line">ad_102|http://www.sohu.com  |["catalog3","catalog6"]                      |</span><br><span class="line">ad_103|http://www.baidu.com |["catalog7"]                                 |</span><br><span class="line">ad_104|http://www.qq.com    |["catalog1","catalog4","catalog5","catalog9"]|</span><br><span class="line">ad_105|http://sina.com      |NULL                                         |</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="列转行"><a href="#列转行" class="headerlink" title="列转行"></a>列转行</h4><p>查询每个广告详情</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">	ad_id,<span class="keyword">catalog</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	ad_tbl</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(catalogs) t <span class="keyword">as</span> <span class="keyword">catalog</span>;</span><br></pre></td></tr></table></figure>

<p>结果:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">ad_id |catalog |</span><br><span class="line"><span class="comment">------|--------|</span></span><br><span class="line">ad_101|catalog8|</span><br><span class="line">ad_101|catalog1|</span><br><span class="line">ad_102|catalog6|</span><br><span class="line">ad_102|catalog3|</span><br><span class="line">ad_103|catalog7|</span><br><span class="line">ad_104|catalog5|</span><br><span class="line">ad_104|catalog1|</span><br><span class="line">ad_104|catalog4|</span><br><span class="line">ad_104|catalog9|</span><br></pre></td></tr></table></figure>

<p><code>注意:</code> 如果ad_tbl的catalogs字段是String类型的，那么在explode炸开的时候要转换成数组，也就是用split把字段元素按’|’切分开返回一个数组</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">lateral view outer explode(split(catalogs,'\\|')) t as catalog</span><br></pre></td></tr></table></figure>

<h2 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h2><p>查用函数的用法查询: <code>desc function extended 函数名;</code></p>
<h3 id="时间函数"><a href="#时间函数" class="headerlink" title="时间函数"></a>时间函数</h3><p><code>current_date:</code> 返回当前日期</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">current_date</span>		<span class="comment">--2019-12-21</span></span><br></pre></td></tr></table></figure>

<p><code>current_timestamp:</code> 返回当前时间</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">current_timestamp</span>	<span class="comment">--2019-12-21 02:23:44</span></span><br></pre></td></tr></table></figure>

<p><code>unix_timestamp:</code> 时间转秒</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">unix_timestamp</span>(<span class="string">'2019-08-15 16:40:00'</span>,<span class="string">'yyyy-MM-dd HH:mm:ss'</span>)   <span class="comment">--1565858400</span></span><br></pre></td></tr></table></figure>

<p><code>from_unixtime:</code> 秒转时间</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> from_unixtime(<span class="number">1565858389</span>,<span class="string">'yyyy-MM-dd HH:mm:ss'</span>)  <span class="comment">--2019-08-15 16:39:49</span></span><br><span class="line"><span class="keyword">select</span> from_unixtime(<span class="keyword">cast</span>(<span class="keyword">substr</span>(<span class="number">1553184000488</span>,<span class="number">1</span>,<span class="number">10</span>) <span class="keyword">as</span> <span class="built_in">int</span>),<span class="string">'yyyy-MM-dd HH:mm:ss'</span>)  <span class="comment">--2019-03-22 00:00:00</span></span><br><span class="line"><span class="keyword">select</span> from_unixtime(<span class="keyword">unix_timestamp</span>(),<span class="string">'yyyy-MM-dd HH:mm:ss'</span>)   <span class="comment">-- 2019-08-15 17:18:55</span></span><br></pre></td></tr></table></figure>

<p><code>to_date:</code> 返回日期</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">to_date</span>(<span class="string">'2009-07-30 04:17:52'</span>) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>;		<span class="comment">--2009-07-30</span></span><br></pre></td></tr></table></figure>

<p><code>year:</code> 返回年份</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">year</span>(<span class="string">'2009-07-30'</span>) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>;		<span class="comment">--2009</span></span><br></pre></td></tr></table></figure>

<p><code>month:</code> 返回月份</p>
<p><code>day:</code> 返回日期</p>
<p><code>hour:</code> 返回小时</p>
<p><code>minute:</code> 返回分钟</p>
<p><code>second:</code> 返回毫秒</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">second</span>(<span class="string">'2009-07-30 12:58:59'</span>) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>; 		<span class="comment">--59</span></span><br></pre></td></tr></table></figure>

<p><code>date_add:</code> 增加指定时间</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">date_add</span>(<span class="string">'2009-07-30'</span>, <span class="number">1</span>) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>;		<span class="comment">--2009-07-31</span></span><br></pre></td></tr></table></figure>

<p><code>date_sub:</code> 减少指定时间</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">date_sub</span>(<span class="string">'2009-07-30'</span>, <span class="number">1</span>) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>;		<span class="comment">--2009-07-29</span></span><br></pre></td></tr></table></figure>

<h3 id="数值函数"><a href="#数值函数" class="headerlink" title="数值函数"></a>数值函数</h3><p><code>round:</code> 返回指定范围的数值</p>
<p><code>ceil:</code> 返回天花板，取最大的整数值</p>
<p><code>floor:</code> 返回地板，去最小的整数值</p>
<p><code>abs:</code> 返回绝对值</p>
<p><code>least:</code> 数列中最小值 ==&gt; min</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">least</span>(<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>;		<span class="comment">--1</span></span><br></pre></td></tr></table></figure>

<h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><p><code>substr:</code> 返回截取字符串</p>
<p><code>concat:</code> 返回连接字符串</p>
<p><code>concat_ws:</code> 根据特定格式组合字符串</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">concat_ws</span>(<span class="string">'.'</span>, <span class="string">'www'</span>, <span class="built_in">array</span>(<span class="string">'facebook'</span>, <span class="string">'com'</span>)) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>;	<span class="comment">--www.facebook.com</span></span><br></pre></td></tr></table></figure>

<p><code>length:</code> 返回字符串的长度，整数值</p>
<p><code>split:</code> 返回切分后的字符串数组</p>
<p><code>upper:</code> 字符转大写</p>
<p><code>lower:</code> 字符转小写</p>
<h3 id="Json处理函数"><a href="#Json处理函数" class="headerlink" title="Json处理函数"></a>Json处理函数</h3><ol>
<li><p>第一步准备数据</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"movie"</span>:<span class="string">"1"</span>,<span class="attr">"rate"</span>:<span class="string">"5"</span>,<span class="attr">"time"</span>:<span class="string">"978300760"</span>,<span class="attr">"userid"</span>:<span class="string">"1"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"movie"</span>:<span class="string">"2"</span>,<span class="attr">"rate"</span>:<span class="string">"4"</span>,<span class="attr">"time"</span>:<span class="string">"978702109"</span>,<span class="attr">"userid"</span>:<span class="string">"1"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"movie"</span>:<span class="string">"3"</span>,<span class="attr">"rate"</span>:<span class="string">"3"</span>,<span class="attr">"time"</span>:<span class="string">"978401968"</span>,<span class="attr">"userid"</span>:<span class="string">"1"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"movie"</span>:<span class="string">"4"</span>,<span class="attr">"rate"</span>:<span class="string">"4"</span>,<span class="attr">"time"</span>:<span class="string">"978300275"</span>,<span class="attr">"userid"</span>:<span class="string">"1"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"movie"</span>:<span class="string">"5"</span>,<span class="attr">"rate"</span>:<span class="string">"3"</span>,<span class="attr">"time"</span>:<span class="string">"978801091"</span>,<span class="attr">"userid"</span>:<span class="string">"1"</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步建表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> rating_json(</span><br><span class="line">	<span class="keyword">json</span> <span class="keyword">string</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步加载数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/hadoop/data/rating.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> rating_json;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步查看数据</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">json                                                    |</span><br><span class="line"><span class="comment">--------------------------------------------------------|</span></span><br><span class="line">&#123;"movie":"1","rate":"5","time":"978300760","userid":"1"&#125;|</span><br><span class="line">&#123;"movie":"2","rate":"4","time":"978702109","userid":"1"&#125;|</span><br><span class="line">&#123;"movie":"3","rate":"3","time":"978401968","userid":"1"&#125;|</span><br><span class="line">&#123;"movie":"4","rate":"4","time":"978300275","userid":"1"&#125;|</span><br><span class="line">&#123;"movie":"5","rate":"3","time":"978801091","userid":"1"&#125;|</span><br></pre></td></tr></table></figure>
</li>
<li><p>对数据进行处理</p>
<p><code>json_tuple:</code> 返回指定json文件的指定字段，返回的是字符串</p>
<p><code>select json_tuple(json,&quot;movie&quot;,&quot;rate&quot;,&quot;time&quot;,&quot;userid&quot;) as (movie,rate,time,userid) from rating_json;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">movie|rate|time     |userid|</span><br><span class="line"><span class="comment">-----|----|---------|------|</span></span><br><span class="line">1    |5   |978300760|1     |</span><br><span class="line">2    |4   |978702109|1     |</span><br><span class="line">3    |3   |978401968|1     |</span><br><span class="line">4    |4   |978300275|1     |</span><br><span class="line">5    |3   |978801091|1     |</span><br></pre></td></tr></table></figure>

<p><code>parse_url_tuple:</code> 返回指定url的指定字段，返回的是字符串</p>
<p><code>select parse_url_tuple(&quot;https://www.baidu.com/bigdate/spark?cookie_id=10&quot;,&#39;HOST&#39;,&#39;PATH&#39;,&#39;QUERY&#39;,&#39;QUERY:cookie_id&#39;);</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">c0           |c1            |c2          |c3|</span><br><span class="line"><span class="comment">-------------|--------------|------------|--|</span></span><br><span class="line">www.baidu.com|/bigdate/spark|cookie_id=10|10|</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="Null值处理函数"><a href="#Null值处理函数" class="headerlink" title="Null值处理函数"></a>Null值处理函数</h3><p><code>isnull:</code> 指定字段的元素如果为null则返回true</p>
<p><code>isnotnull:</code> 指定字段的元素如果不为null则返回true</p>
<p><code>elt:</code> 指定返回的元素</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">elt</span>(<span class="number">1</span>, <span class="string">'face'</span>, <span class="string">'book'</span>) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>;		<span class="comment">--face</span></span><br></pre></td></tr></table></figure>

<p><code>nvl:</code> 替换null值</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> nvl(<span class="literal">null</span>,<span class="string">'bla'</span>) <span class="keyword">FROM</span> src <span class="keyword">LIMIT</span> <span class="number">1</span>;	<span class="comment">--bla</span></span><br></pre></td></tr></table></figure>

<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><p><code>cast:</code> 转换数据类型</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">cast(time as bigint)	<span class="comment">--时间转数值</span></span><br><span class="line">cast(string as date)	<span class="comment">--字符串转日期</span></span><br></pre></td></tr></table></figure>

<p><code>注意:</code> binary只能转string</p>
<h2 id="静动态分区表"><a href="#静动态分区表" class="headerlink" title="静动态分区表"></a>静动态分区表</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol>
<li><p>数据源</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">1,jack,shanghai,20190129</span><br><span class="line">2,kevin,beijing,20190130</span><br><span class="line">3,lucas,hangzhou,20190129</span><br><span class="line">4,lily,hangzhou,20190130</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建源数据表（外表）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> prit_tbl(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">	address <span class="keyword">string</span>,</span><br><span class="line">	<span class="keyword">day</span> <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">","</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载数据：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/hadoop/data/partition.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> prit_tbl;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建分区表（外表）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> prit_tbl(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">	address <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">day</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">","</span>;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="静态分区加载数据"><a href="#静态分区加载数据" class="headerlink" title="静态分区加载数据"></a>静态分区加载数据</h3><ul>
<li><p>静态分区缺点：每次写入都要明确指定分区日期。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> prit_tbl <span class="keyword">partition</span>(<span class="keyword">day</span>=<span class="string">"20190129"</span>) <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,address <span class="keyword">from</span> test_tbl <span class="keyword">where</span> <span class="keyword">day</span> = <span class="string">"20190129"</span> ;</span><br></pre></td></tr></table></figure>

<p><code>注意:</code> 并且在查询处不能包含分区字段day，否则会报错</p>
</li>
</ul>
<h3 id="动态分区加载数据"><a href="#动态分区加载数据" class="headerlink" title="动态分区加载数据"></a>动态分区加载数据</h3><ul>
<li><p>查看表分区</p>
<p><code>show partitions prit_tbl;</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">partition   |</span><br><span class="line"><span class="comment">------------|</span></span><br><span class="line">day=20190129|</span><br><span class="line">day=20190130|</span><br></pre></td></tr></table></figure>
</li>
<li><p>自动识别分区，不需要明确指定</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition=<span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> prit_tbl <span class="keyword">partition</span>(<span class="keyword">day</span>) <span class="keyword">select</span> * <span class="keyword">from</span> test_tbl;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询验证：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> prit_tbl;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> prit_tbl <span class="keyword">where</span> <span class="keyword">day</span> = <span class="number">20190129</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> prit_tbl <span class="keyword">where</span> <span class="keyword">day</span> = <span class="number">20190130</span>;</span><br></pre></td></tr></table></figure>

<p>HDFS web界面验证</p>
</li>
</ul>
<h3 id="分区注意"><a href="#分区注意" class="headerlink" title="分区注意"></a>分区注意</h3><ol>
<li><p>尽量不要是用动态分区，因为动态分区的时候，将会为每一个分区分配reducer数量，当分区数量多的时候，reducer数量将会增加，对服务器是一种灾难。</p>
</li>
<li><p>动态分区和静态分区的区别: 静态分区不管有没有数据都将会创建该分区，动态分区是有结果集将创建，否则不创建。</p>
</li>
<li><p>hive动态分区的严格模式和hive提供的<code>hive.mapred.mode的</code>严格模式,为了阻止用户不小心提交恶意<code>hql</code>。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">hive.mapred.mode=nostrict : strict</span><br></pre></td></tr></table></figure>

<p>如果该模式值为strict，将会阻止以下三种查询：</p>
<ol>
<li>对分区表查询，where中过滤字段不是分区字段。</li>
<li>笛卡尔积join查询，join查询语句，不带on条件 或者 where条件。</li>
<li>对order by查询，有order by的查询不带limit语句。</li>
</ol>
</li>
</ol>
<h2 id="桶表"><a href="#桶表" class="headerlink" title="桶表"></a>桶表</h2><h3 id="分桶的概念"><a href="#分桶的概念" class="headerlink" title="分桶的概念"></a>分桶的概念</h3><p>分区提供一个隔离数据和优化查询的便利方式。不过，并非所有的数据集都可形成合理的分区。对于一张表或者分区，Hive 可以进一步组织成桶，也就是更为细粒度的数据范围划分。</p>
<p>分桶是将数据集分解成更容易管理的若干部分的另一个技术。</p>
<p><code>分区针对的是数据的存储路径；分桶针对的是数据文件。</code></p>
<h3 id="分桶的好处"><a href="#分桶的好处" class="headerlink" title="分桶的好处"></a>分桶的好处</h3><ul>
<li>分桶规则：对分桶字段值进行哈希，哈希值除以桶的个数求余，余数决定了该条记录在哪个桶中，也就是余数相同的在一个桶中。</li>
<li>优点：<ol>
<li>提高join查询效率 </li>
<li>提高抽样效率</li>
</ol>
</li>
</ul>
<h3 id="分桶实践"><a href="#分桶实践" class="headerlink" title="分桶实践"></a>分桶实践</h3><ol start="2">
<li><p>准备数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1,name1</span><br><span class="line">2,name2</span><br><span class="line">3,name3</span><br><span class="line">4,name4</span><br><span class="line">5,name5</span><br><span class="line">6,name6</span><br><span class="line">7,name7</span><br><span class="line">8,name8</span><br><span class="line">9,name9</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建桶表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> bucket_tbl(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line">clustered <span class="keyword">by</span>(<span class="keyword">id</span>) </span><br><span class="line"><span class="keyword">into</span> <span class="number">4</span> buckets</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">","</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建中间表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> mid_tbl(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">","</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载数据到中间表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/hadoop/data/bucket.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> mid_tbl;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置强制分桶</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set hive.enforce.bucketing = true; --Hive 2.x 不需要这一步</span><br><span class="line">set mapreduce.job.reduces=-1;</span><br></pre></td></tr></table></figure>

<p>在 Hive 0.x and 1.x 版本，必须使用设置 <code>hive.enforce.bucketing = true</code>，表示强制分桶，允许程序根据表结构自动选择正确数量的 Reducer 和 cluster by column 来进行分桶。</p>
</li>
<li><p>插入数据到分桶表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> bucket_tbl <span class="keyword">select</span> * <span class="keyword">from</span> mid_tbl;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看结果</p>
<p>HDFS：<code>桶是以文件的形式存在的，而不是像分区那样以文件夹的形式存在。</code></p>
<p><img src="https://upload-images.jianshu.io/upload_images/12267859-d7e00bb44b332b5b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/format/webp" alt="分桶文件"></p>
</li>
</ol>
<h3 id="有序的分桶表"><a href="#有序的分桶表" class="headerlink" title="有序的分桶表"></a>有序的分桶表</h3><ul>
<li><p>如果要按id升序排序可以这样建表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_bucket_sorted (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">comment</span> <span class="string">'ID'</span>, </span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span> <span class="keyword">comment</span> <span class="string">'名字'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">comment</span> <span class="string">'测试分桶'</span></span><br><span class="line">clustered <span class="keyword">by</span>(<span class="keyword">id</span>) </span><br><span class="line">sorted <span class="keyword">by</span> (<span class="keyword">id</span>) </span><br><span class="line"><span class="keyword">into</span> <span class="number">4</span> buckets</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span> ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> bucket_tbl(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line">clustered <span class="keyword">by</span>(<span class="keyword">id</span>) sorted <span class="keyword">by</span> (<span class="keyword">id</span>) <span class="keyword">into</span> <span class="number">4</span> buckets</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">","</span>;</span><br></pre></td></tr></table></figure>

<p><code>注意:</code> 同样需要中间表insert插入数据</p>
</li>
<li><p>好处:</p>
<p>因为每个桶内的数据是排序的，这样每个桶进行连接时就变成了高效的归并排序</p>
</li>
</ul>
<h3 id="分桶抽样查询"><a href="#分桶抽样查询" class="headerlink" title="分桶抽样查询"></a>分桶抽样查询</h3><p>对于非常大的数据集，有时用户需要使用的是一个具有代表性的查询结果而不是全部结果。Hive可以通过对表进行抽样来满足这个需求。</p>
<h4 id="SQL示例"><a href="#SQL示例" class="headerlink" title="SQL示例"></a>SQL示例</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">hive&gt; select * from test_bucket tablesample (bucket 1 out of 2);</span><br><span class="line">OK</span><br><span class="line">8   name8</span><br><span class="line">4   name4</span><br><span class="line">2   name2</span><br><span class="line">6   name6</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">hive&gt; select * from test tablesample (bucket 1 out of 2 on id);</span><br><span class="line">OK</span><br><span class="line">2   name2</span><br><span class="line">8   name8</span><br><span class="line">4   name4</span><br><span class="line">6   name6</span><br></pre></td></tr></table></figure>

<h4 id="区别"><a href="#区别" class="headerlink" title="区别:"></a>区别:</h4><ul>
<li>分桶表后面可以不带on 字段名，不带时默认的是按分桶字段,也可以带，而没有分桶的表则必须带</li>
<li>按分桶字段取样时，因为分桶表是直接去对应的桶中拿数据，在表比较大时会提高取样效率</li>
</ul>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法:"></a>语法:</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">tablesample (bucket x out of y on id);</span><br></pre></td></tr></table></figure>

<p>x表示从哪个桶开始，y代表分几个桶，也可以理解分x为分子，y为分母，及将表分为y份（桶），取第x份（桶）</p>
<p>所以这时对于分桶表是有要求的，y为桶数的倍数或因子，</p>
<ul>
<li><p>x=1,y=2，取2(4/y)个bucket的数据，分别桶1和桶3(1+y)</p>
</li>
<li><p>x=1,y=4, 取1(4/y)个bucket的数据，即桶1</p>
</li>
<li><p>x=2,y=8, 取1/2(4/y)个bucket的数据，即桶1的一半</p>
<p> x的值必须小于等于y的值</p>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Tunan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yerias.github.io/2018/11/05/hive/5/">http://yerias.github.io/2018/11/05/hive/5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Hive/">Hive</a></div><div class="social-share" data-disabled="facebook,twitter,douban,linkedin,diandian"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/11/06/hive/6/"><i class="fa fa-chevron-left">  </i><span>Order By&amp;Sort By&amp;Distribute By&amp;Cluster By</span></a></div><div class="next-post pull-right"><a href="/2018/11/04/hive/4/"><span>Hive数据类型&amp;DDL数据定义(增删查改)&amp;DML数据操作(导入导出)</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/soroush-golpoor-1497416-unsplash.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By Tunan</div><div class="framework-info"><span>Driven - </span><a href="#"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="#"><span>Melody</span></a></div><div class="footer_custom_text">大家好，我是图南，很高兴认识你们！</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>